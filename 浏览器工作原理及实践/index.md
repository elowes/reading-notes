# 浏览器工作原理及实践

## 宏观视角下的浏览器

### HTTP请求流程：为什么很多站点第二次打开速度会很快？

- 浏览器使用 HTTP 协议作为应用层协议，用来封装请求的文本信息；并使用 TCP/IP 作传输层协议将它发到网络上，所以在 HTTP 工作开始之前，浏览器需要通过 TCP 与服务器建立连接。也就是说 HTTP 的内容是通过 TCP 的传输数据阶段来实现的，你可以结合下图更好地理解这二者的关系。
![TCP 和 HTTP 的关系示意图](./1.png)
  > 网络七层协议   
  从下往上依次为物理层、数据链路层、网络层、传输层、会话层、表示层和应用层

### 渲染流程：HTML、CSS 和 JavaScript，是如何变成页面的？

- 按照渲染的时间顺序，流水线可分为如下几个子阶段：构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成。

#### 构建 DOM 树

- 为什么要构建 DOM 树呢？这是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构 —— DOM 树。
![DOM 树构建过程示意图](./2.png)

#### 样式计算

- 和 HTML 文件一样，浏览器也是无法直接理解这些纯文本的 CSS 样式，所以当渲染引擎接收到 CSS 文本时，会执行一个转换操作，将 CSS 文本转换为浏览器可以理解的结构 —— styleSheets。只需要在控制台中输入 document.styleSheets，然后就看到如下图所示的结构：
![styleSheets](./3.png)

- 现在我们已经把现有的 CSS 文本转化为浏览器可以理解的结构了，那么接下来就要对其进行属性值的标准化操作。  
要理解什么是属性值标准化，你可以看下面这样一段 CSS 文本：  
  ```css
  body { font-size: 2em }
  p {color:blue;}
  span  {display: none}
  div {font-weight: bold}
  div  p {color:green;}
  div {color:red; }
  ```
  可以看到上面的 CSS 文本中有很多属性值，如 2em、blue、bold，这些类型数值不容易被渲染引擎理解，所以需要将所有值转换为渲染引擎容易理解的、标准化的计算值，这个过程就是属性值标准化。  
  那标准化后的属性值是什么样子的？
  ![标准化属性值](./4.png)

- 计算出 DOM 树中每个节点的具体样式，这里就涉及到 CSS 的继承规则和层叠规则了。CSS 继承就是每个 DOM 节点都包含有父节点的样式。样式计算过程中的第二个规则是样式层叠。层叠是 CSS 的一个基本特征，它是一个定义了如何合并来自多个源的属性值的算法。它在 CSS 处于核心地位，CSS 的全称“层叠样式表”正是强调了这一点。

#### 布局阶段

- 现在，我们有 DOM 树和 DOM 树中元素的样式，但这还不足以显示页面，因为我们还不知道 DOM 元素的几何位置信息。那么接下来就需要计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫做布局。
  > 布局阶段主要完全两个任务：创建布局树和布局计算。  
  DOM 树中还含有很多不可见的元素，比如 `head` 标签，还有使用了 `display: none` 属性的元素。所以在显示之前，我们还要额外地创建一棵只包含可见元素布局树。  
  有了一棵完整的布局树。那么接下来，就要计算布局树节点的坐标位置了。在执行布局操作的时候，会把布局运算的结果重新写回布局树中，所以布局树既是输入内容也是输出内容，这是布局阶段一个不合理的地方，因为在布局阶段并没有清晰地将输入内容和输出内容区分开来。针对这个问题，Chrome 团队正在重构布局代码，下一代布局系统叫 LayoutNG，试图更清晰地分离输入和输出，从而让新设计的布局算法更加简单。
